<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>教师提醒</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="renderer" content="webkit">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">   
  <!-- <link rel="alternate icon" type="image/png" href="/thirdparty/amazeui/i/favicon.png"> -->
  <link rel="stylesheet" href="/thirdparty/amazeui/css/amazeui.css"/>
  <link rel="stylesheet" href="/thirdparty/amazeui/css/sumoselect.css"/>
  <script type="text/javascript" src="../js/common/jquery-2.1.3.js"></script>
  <script type="text/javascript" src="/thirdparty/amazeui/js/amazeui.js"></script>
  <script type="text/javascript" src="/thirdparty/amazeui/js/amazeui.widgets.helper.min.js"></script>
  <!-- <script type="text/javascript" src="/thirdparty/amazeui/js/jquery.sumoselect.min.js"></script> -->
  
  <style>
    .header {
      text-align: center;
    }
    .header h1 {
      font-size: 200%;
      color: #333;
      margin-top: 30px;
    }
    .header p {
      font-size: 14px;
    }
    #wrapper {
      position: absolute;
      top: 52px;
      bottom: 0;
      overflow: hidden;
      margin: 0;
      width: 100%;
      padding: 0 8px;
      background-color: #f8f8f8;
    }
  </style>
</head>
<body>
 <header data-am-widget="header" class="am-header am-header-default">

      <h1 class="am-header-title">
            教师提醒
      </h1>

  </header>
<div class="am-g">
  <div class="am-u-lg-6 am-u-md-8 am-u-sm-centered am-margin-top">

    <form id="mainform" class="am-form" >
          
      
      <div class="am-g am-margin-bottom">
      <label for="title" class="am-u-sm-3">标题</label>
      <div class="am-u-sm-9"><input type="text" class="" id="title" minlength="3" placeholder="输入标题（至少 3 个字符）" required></div>
      </div>
      
      <div class="am-g am-margin-bottom">
      <label for="studentlisttxt" class="am-u-sm-3">被提醒人</label>
      <div class="am-u-sm-9"><input type="text" class="" id="studentlisttxt" placeholder="请选择学生" readonly style="background-color:#FFFFFF"></div>
      </div>
      
     <!--  <div class="am-g am-margin-bottom">
      <label for="studentlist" class="am-u-sm-3">被提醒人</label>
      <div class="am-u-sm-9">
     
            
            <select multiple="multiple" placeholder="Hello  im from placeholder" class="SlectBox" id="studentlist">
 
            </select>
		</div>
      </div> -->
      
      <div class="am-g am-margin-bottom">
	      <label for="doc-ta-1" class="am-u-sm-3">文本域</label>
	      <div class="am-u-sm-9"> <textarea class="" rows="5" id="memo" minlength="3" maxlength="100"></textarea></div>
      </div>
      
     <div class="am-g am-margin-bottom ">
	      <label class="am-u-sm-3">添加附件</label>
	      <div class="am-u-sm-9" id="uploadwapper">
	      	<div class="am-margin-bottom-sm am-form-file">
	      		<button type="button" class="am-btn am-btn-default am-btn-sm" ><i class="am-icon-cloud-upload"></i> 请选择文件</button>
	      		<input id="doc-form-file" type="file">
	      	</div>	      
		  </div>
      </div>
    <div id="file-list"></div>      
	<div class="am-g">
	      <label for="doc-ta-1" class="am-u-sm-3"></label>
	      <div class="am-u-sm-9"><button type="button" onclick="ajaxsubmit();" class="am-btn am-btn-success">提交</button></div>
      </div>
      
    </form>

  </div>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">确认框</div>
    <div class="am-modal-bd">
      确定提交吗？
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
    </div>
  </div>
</div>

<div class="am-modal am-modal-alert" tabindex="-1" id="my-alert">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">提示框</div>
    <div class="am-modal-bd">
      添加成功！
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn">确定</span>
    </div>
  </div>
</div>

<div class="am-modal am-modal-alert" tabindex="-1" id="common-alert">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">提示框</div>
    <div class="am-modal-bd">
      添加成功！
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn">确定</span>
    </div>
  </div>
</div>

	<div class="doc-example">
		<div class="am-popup" id="my-popup">
		  <header id="popupheader" data-am-widget="header" class="am-header am-header-default " style="position:absolute;top:0px;background-color:#fff;border-bottom:2px solid #0e90d2;padding-top:6px">
		    <label class="am-checkbox am-fl"><input id="chk_selectAll" type="checkbox" value="0" data-am-ucheck>全选 </label>
		    <!-- <button id="btn_cancel_alarm" type="button" class="am-btn am-btn-sm am-btn-danger am-radius am-fr am-margin-horizontal-xs">取消</button> -->
			<button id="btn_close_alarm" class="am-btn am-btn-sm am-btn-primary am-radius am-fr am-margin-horizontal-xs">关闭</button>
			<span class="am-margin-top-xs am-margin-horizontal-xs am-fr" style="line-height:26px">已选中<span id="spn_selectednum_alarm" class="am-badge am-badge-success">0</span>人</span>
		  </header>		
		  <div id="wrapper" data-am-widget="list_news"
		       class="am-list-news am-list-news-default">
			 <ul class="am-list am-list-static am-list-border">
				 
				</ul>
			  </div>  
			</div>
	</div>
<script>

	 /**
     *    侦查附件上传情况    ,这个方法大概0.05-0.1秒执行一次
     */
    var student_list = [],student_list_all = [];
    Array.prototype.indexOf = function(val) {
        for (var i = 0; i < this.length; i++) {
            if (this[i].user_id == val) return i;
        }
        return -1;
    };
    Array.prototype.remove = function(val) {
        var index = this.indexOf(val);
        if (index > -1) {
            this.splice(index, 1);
        }
    };
    function onprogress(evt){
        var loaded = evt.loaded;                  //已经上传大小情况 
        var tot = evt.total;                      //附件总大小 
        var per = Math.floor(100*loaded/tot);      //已经上传的百分比  
        $('#uploadwapper').find(".am-progress-bar:last").css("width" , per +"%");
    }
    function savefile(file_path){
    	 $('#uploadwapper').find(".upload-item:last").data('filepath',file_path);
    }
    function uidel(elem){
    	$(elem).parents('.upload-item').remove();
    }
    
    function commonalert(msg){
    	$('#common-alert .am-modal-bd').html(msg);
    	$('#common-alert').modal();
    }
	function ajaxsubmit(){
		if($('#mainform').validator('isFormValid')){
			if(student_list.length==0){
				$("#studentlisttxt").removeClass("am-field-valid");
				$("#studentlisttxt").addClass("am-field-error");
				return false;
			}
			$('#my-confirm').modal({
		        onConfirm: function(options) {	
		    		var title = $('#title').val(),
					memo = $('#memo').val(),
					scid = '34',
					class_no = '02',
					school_year = '08'
					user_id = 'mtbi2',
					filelist = $('#uploadwapper .upload-item'),
				    file_list = [];
		        		 filelist.each(function(){
		        			 file_list.push({"file_path" : $(this).data('filepath')});
		        		  });
		        		//================ 提交数据到后台
		        		var params = {
	        				scid : scid,
	    					class_no : class_no,
	    					school_year : school_year,
	    					user_id : user_id,
	    					title : title,
	    					memo : memo,
	    					student_list : student_list,
	    					file_list : file_list
		    			};			        		
		        		getAjaxData("/tch/addAlarmMyClass.do","post", params,function(data){
		        			var optshtml='';
		        			if (data.resultcode == '0000') {
		        				$('#my-alert .am-modal-bd').text('添加成功！');
		        				$('#my-alert').modal();
		         	/*			for (var i = 0; i < data.result.length; i++) {
		        					optshtml+='<option value="'+data.result[i].user_id+'">'+data.result[i].user_name+'</option>';
		        				}
		        				$("#studentlist").append(optshtml);
		        				$('.SlectBox').SumoSelect({ csvDispCount: 3 });*/

		        			} else {
		        				$('#my-alert .am-modal-bd').text('添加失败！');
		        				$('#my-alert').modal();
		        			}
		        		}); 
		        		
		        		//============================
		        },
		        // closeOnConfirm: false,
		        onCancel: function() {
		        }
		      });
		}else{
			if(student_list.length==0){
				$("#studentlisttxt").removeClass("am-field-valid");
				$("#studentlisttxt").addClass("am-field-error");
			}
		}
		/*$.when($('#mainform').validator('isFormValid')).then(function() {
			 $('#my-confirm').modal({
			        onConfirm: function(options) {	
			    		var title = $('#title').val(),
						memo = $('#memo').val(),
						scid = '34',
						class_no = '02',
						school_year = '08'
						user_id = 'mtbi2',
						filelist = $('#uploadwapper .upload-item'),
					    file_list = [];
			        		 filelist.each(function(){
			        			 file_list.push({"file_path" : $(this).data('filepath')});
			        		  });
			        		//================ 提交数据到后台
			        		var params = {
		        				scid : scid,
		    					class_no : class_no,
		    					school_year : school_year,
		    					user_id : user_id,
		    					title : title,
		    					memo : memo,
		    					student_list : student_list,
		    					file_list : file_list
			    			};			        		
			        		getAjaxData("/tch/addAlarmMyClass.do","post", params,function(data){
			        			var optshtml='';
			        			if (data.resultcode == '0000') {
			        				$('#my-alert .am-modal-bd').text('添加成功！');
			        				$('#my-alert').modal();
			        			} else {
			        				$('#my-alert .am-modal-bd').text('添加失败！');
			        				$('#my-alert').modal();
			        			}
			        		}); 
			        		
			        		//============================
			        },
			        // closeOnConfirm: false,
			        onCancel: function() {
			        }
			      });
		})*/
	     
	}

	  $(function() {		
			$("#chk_selectAll").on('click',function(e){
				if($("#chk_selectAll").is(':checked')){
					$("#wrapper li i").remove();
					$("#wrapper li").append('<i class="am-icon-check am-fr am-text-success"></i>');
					$("#spn_selectednum_alarm").text($("#wrapper li").length);
					student_list = student_list_all.concat();
				}else{
					$("#wrapper li i").remove();
					$("#spn_selectednum_alarm").text(0);
					student_list=[];
				}
			});
		  $('#mainform').validator({
			  validateOnSubmit: true,
			  allFields: ':input:visible:not(:button, :disabled, .am-novalidate)',
			  validate: function(validity) {
				 /*if ($(validity.field).is('#studentlist')) {
						if($("#studentlist").val()==null){
							$(".CaptionCont").removeClass("am-field-valid");
							$(".CaptionCont").addClass("am-field-error");
							validity.valid = false;
						}else{
							$(".CaptionCont").removeClass("am-field-error");
							$(".CaptionCont").addClass("am-field-valid");
							validity.valid = true;
						}
				         return validity;
				      }
			  if ($(validity.field).is('#studentlisttxt')) {
					if(student_list.length==0){
				//		$(this).removeClass("am-field-valid");
				//		$(this).addClass("am-field-error");
						validity.valid = false;
					}else{
				//		$(this).removeClass("am-field-error");
				//		$(this).addClass("am-field-valid");
						validity.valid = true;
					}
			         return validity;
			      }*/
			  }
		  });

		 //上传
	    $('#doc-form-file').on('change', function() {
	    	var file = this.files[0];	
	    	if(file.size / 1024 > 2000){
	    		commonalert("文件不能超过2M");
	    		return false;
	    	}
	    	var filehtml='';
	    	filehtml+='<div class="am-margin-bottom-sm upload-item"><div class="am-g am-margin-bottom-xs"><div class="am-u-sm-9">';
	    	filehtml+=file.name;
	    	filehtml+='</div><div class="am-u-sm-3"><button type="button" class="am-btn am-btn-danger am-btn-xs am-fr" onclick="uidel(this)">删除</button></div></div><div class="am-progress am-progress-xs"><div class="am-progress-bar"></div></div></div>';
	    	
	    	$('#uploadwapper').append(filehtml);
	    	
	        var formData = new FormData();
	        formData.append("uploadInputFile" , file);
	        formData.append("userId","mtbi2")
	    	
	        $.ajax({
	            type: "POST",
	            url: "/tch/fileUpload.do",
	            data: formData ,
	            processData : false,  
	            //必须false才会自动加上正确的Content-Type   
	            contentType : false , 
	            xhr: function(){
	                 var xhr = $.ajaxSettings.xhr();
	                 if(onprogress && xhr.upload) {
	                     xhr.upload.addEventListener("progress" , onprogress, false);
	                     return xhr;
	                 }
	             },
	             success:function(data){
	            	 savefile(data.result);
	            	 //file_list.push({"file_path" : data.result});
	             }   
	         });
	    });
	    
	    var myScroll = this.iScroll = new $.AMUI.iScroll('#wrapper', {
		    click: true
		  });
		$("#studentlisttxt").on('click',function(e){		
			$("#my-popup").modal();
			myScroll.refresh();
		});
		$("#btn_close_alarm").on('click',function(e){
			/*var studentlist = $("#wrapper li i");
			student_list=[];
			studentlist.each(function(){
			 student_list.push({"user_id" : $(this).parent().data('userid')});
   		    });	*/	
			if(student_list.length>0){
				$('#studentlisttxt').val('已选中'+student_list.length+'个');
				$("#studentlisttxt").removeClass("am-field-error");
				$("#studentlisttxt").addClass("am-field-valid");
			}else{
				$('#studentlisttxt').val('');
				$("#studentlisttxt").removeClass("am-field-valid");
				$("#studentlisttxt").addClass("am-field-error");
			}
			$("#my-popup").modal('close');
		});
		$("#btn_cancel_alarm").on('click',function(e){
			$("#my-popup").modal('close');
		});
	
		$("#wrapper").on('click','li',function(e){
			var i = $(this).children('i');
			if(i.length==0){
				$(this).append('<i class="am-icon-check am-fr am-text-success"></i>');
				$("#spn_selectednum_alarm").text(parseInt($("#spn_selectednum_alarm").text())+1);
				student_list.push({"user_id" : $(this).data('userid')});
			}else{
				i.remove();
				$("#spn_selectednum_alarm").text(parseInt($("#spn_selectednum_alarm").text())-1);
				student_list.remove($(this).data('userid'));
			}
		});
		
	 
	  });
	  
	  
	  var readyFunc = function onBridgeReady() {
			var curid;
			var curAudioId; 
			var playStatus = 0;

			// 关闭当前webview窗口 - closeWindow
			document.querySelector('#my-alert .am-modal-btn')
					.addEventListener('click', function(e) {
						WeixinJSBridge.invoke('closeWindow', {}, function(res) {
							// alert(res.err_msg);
						});
					});
		}
		if (typeof WeixinJSBridge === "undefined") {
			document.addEventListener('WeixinJSBridgeReady', readyFunc, false);
		} else {
			readyFunc();
		}
	</script>	
	<script type="text/javascript" src="../js/common/_config.js"></script>
<script type="text/javascript" src="../js/common/cts_common.js"></script>
<script type="text/javascript" src="../js/weixin/alarm_add.js"></script>
</body>
</html>





