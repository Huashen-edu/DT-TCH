$(function() {
	tchSubTempFrame.alarmAdd = {};
	// init
	tchSubTempFrame.alarmAdd.init = function(){
		// 获取微信用户信息信息
		// 获取 授权 回调 code
		var wmcode = GetQueryString("code");
		var paramsCode = {
				code : wmcode
			};
		// 获取 微信userinfo
		getAjaxPostData(
				'getWXUserInfo.do?',
				paramsCode,
				true,
				function(data) {
					var response = data;
					if (response.resultcode == '0000'
							&& typeof (response.result) == "object") {
						if (response.result.user_id != null) {
							if (response.result.scid == null) {
								commonAlert('用户信息数据出现异常。', false, null, null);
								return;
							}
							params = {
								scid : response.result.scid,
								class_no : response.result.class_no,
								school_year : response.result.school_year
							}
							user_id = response.result.user_id;
							tchSubTempFrame.alarmAdd.dataInit();
						} else {
							commonAlert(
									'您还没有进行授权登录！<br>关闭此画面，在<strong>[更多]</strong>-<strong>[授权登录]</strong>进行授权。',
									false, null, null);
						}
					}
				});
		//==============================test begin========================
//				params = {
//							scid : '34',
//							class_no : '02',
//							school_year : '08'
//					};
//			tchSubTempFrame.alarmAdd.dataInit();
		//==============================test end========================		
		}
	//初始化学生列表
	tchSubTempFrame.alarmAdd.dataInit = function(){
		getAjaxPostData("getAddressBookStudentsList.do?", params, true, function(data){
			var optshtml='';
			if (data.resultcode == '0000') {
				for (var i = 0; i < data.result.length; i++) {
					optshtml+='<li data-userid="'+data.result[i].user_id+'">'+data.result[i].user_name+'</li>';
					student_list_all.push({"user_id" : data.result[i].user_id});
				}
				$("#wrapper ul").append(optshtml);
			} else {
				commonAlert('<strong>目录信息</strong><br />连接失败。', false,
						null, null); 
				return;
			}
		});
	}
	tchSubTempFrame.alarmAdd.init();	 
});
var student_list = [],//上传学生列表
student_list_all = [];//所有学生列表缓存（全选时用）
var params = {},user_id;

/**
 * 删除学生
 * @param val
 */
function studentlistremove(val){
	for (var i = 0; i < student_list.length; i++) {
        if (student_list[i].user_id == val){
        	student_list.splice(i, 1);
        }
    }
}

/***************************************/
/** 上传进度条 */
function onprogress(evt){
    var loaded = evt.loaded;                  //已经上传大小情况 
    var tot = evt.total;                      //附件总大小 
    var per = Math.floor(100*loaded/tot);      //已经上传的百分比  
    $('#uploadwapper').find(".am-progress-bar:last").css("width" , per +"%");
}
/** 保存上传文件后返回的附件地址 */
function savefile(file_path){
	 $('#uploadwapper').find(".upload-item:last").data('filepath',file_path);
}
/** 删除附件 */
function uidel(elem){
	$(elem).parents('.upload-item').remove();
}
/***************************************/
/** 通用警告框 */
function commonalert(msg){
	$('#common-alert .am-modal-bd').html(msg);
	$('#common-alert').modal();
}
/** Ajax提交表单 */
function ajaxsubmit(){
	if($('#mainform').validator('isFormValid')){
		if(student_list.length==0){
			$("#studentlisttxt").removeClass("am-field-valid");
			$("#studentlisttxt").addClass("am-field-error");
			return false;
		}
		$('#my-confirm').modal({
	        onConfirm: function(options) {	
	    		var title = $('#title').val(),
				memo = $('#memo').val(),
//				scid = '34',
//				class_no = '02',
//				school_year = '08'
//				user_id = 'mtbi2',
				scid = params.scid,
				class_no = params.class_no,
				school_year = params.school_year,
				user_id = user_id,
				filelist = $('#uploadwapper .upload-item'),
			    file_list = [];
	        		 filelist.each(function(){
	        			 file_list.push({"file_path" : $(this).data('filepath')});
	        		  });
	        		//================ 提交数据到后台
	        		var para = {
        				scid : scid,
    					class_no : class_no,
    					school_year : school_year,
    					user_id : user_id,
    					title : title,
    					memo : memo,
    					student_list : student_list,
    					file_list : file_list
	    			};			        		
	        		getAjaxData("/tch/addAlarmMyClass.do","post", para,function(data){
	        			var optshtml='';
	        			if (data.resultcode == '0000') {
	        				$('#my-alert .am-modal-bd').text('添加成功！');
	        				$('#my-alert').modal();

	        			} else {
	        				$('#my-alert .am-modal-bd').text('添加失败！');
	        				$('#my-alert').modal();
	        			}
	        		}); 
	        },
	        onCancel: function() {
	        }
	      });
	}else{
		if(student_list.length==0){
			$("#studentlisttxt").removeClass("am-field-valid");
			$("#studentlisttxt").addClass("am-field-error");
		}
	}
}
/** 微信端关闭浏览器 */
var readyFunc = function onBridgeReady() {
	var curid;
	var curAudioId; 
	var playStatus = 0;

// 关闭当前webview窗口 - closeWindow
document.querySelector('#my-alert .am-modal-btn')
		.addEventListener('click', function(e) {
			WeixinJSBridge.invoke('closeWindow', {}, function(res) {
				// alert(res.err_msg);
			});
		});
}
if (typeof WeixinJSBridge === "undefined") {
	document.addEventListener('WeixinJSBridgeReady', readyFunc, false);
} else {
	readyFunc();
}

$(function() {		
	//表单验证
	$('#mainform').validator();

	//全选按钮事件
	$("#chk_selectAll").on('click',function(e){
		if($("#chk_selectAll").is(':checked')){
			$("#wrapper li i").remove();
			$("#wrapper li").append('<i class="am-icon-check am-fr am-text-success"></i>');
			$("#spn_selectednum_alarm").text($("#wrapper li").length);
			student_list = student_list_all.concat();
		}else{
			$("#wrapper li i").remove();
			$("#spn_selectednum_alarm").text(0);
			student_list=[];
		}
	});
	
	//上传组件
	$('#doc-form-file').on('change', function() {
		var file = this.files[0];	
		if(file.size / 1024 > 2000){
			commonalert("文件不能超过2M");
			return false;
		}
		var filehtml='';
		filehtml+='<div class="am-margin-bottom-sm upload-item"><div class="am-g am-margin-bottom-xs"><div class="am-u-sm-9">';
		filehtml+=file.name;
		filehtml+='</div><div class="am-u-sm-3"><button type="button" class="am-btn am-btn-danger am-btn-xs am-fr" onclick="uidel(this)">删除</button></div></div><div class="am-progress am-progress-xs"><div class="am-progress-bar"></div></div></div>';
		$('#uploadwapper').append(filehtml);
	    var formData = new FormData();
	    formData.append("uploadInputFile" , file);
	    formData.append("userId","mtbi2")
	    $.ajax({
	        type: "POST",
	        url: "/tch/fileUpload.do",
	        data: formData ,
	        processData : false,  
	        //必须false才会自动加上正确的Content-Type   
	        contentType : false , 
	        xhr: function(){
	             var xhr = $.ajaxSettings.xhr();
	             if(onprogress && xhr.upload) {
	                 xhr.upload.addEventListener("progress" , onprogress, false);
	                 return xhr;
	             }
	         },
	         success:function(data){
	        	 savefile(data.result);
	         }   
	     });
	});
    //被提醒人选择页面滚动插件
	var myScroll = this.iScroll = new $.AMUI.iScroll('#wrapper', {click: true});
	//被提醒人选择页面打开事件
	$("#studentlisttxt").on('click',function(e){		
		$("#my-popup").modal();
		myScroll.refresh();
	});
	//被提醒人选择页面关闭事件
	$("#btn_close_alarm").on('click',function(e){
		if(student_list.length>0){
			$('#studentlisttxt').val('已选中'+student_list.length+'个');
			$("#studentlisttxt").removeClass("am-field-error");
			$("#studentlisttxt").addClass("am-field-valid");
		}else{
			$('#studentlisttxt').val('');
			$("#studentlisttxt").removeClass("am-field-valid");
			$("#studentlisttxt").addClass("am-field-error");
		}
		$("#my-popup").modal('close');
	});
	//被提醒人选择、取消事件
	$("#wrapper").on('click','li',function(e){
		var i = $(this).children('i');
		if(i.length==0){
			$(this).append('<i class="am-icon-check am-fr am-text-success"></i>');
			$("#spn_selectednum_alarm").text(parseInt($("#spn_selectednum_alarm").text())+1);
			student_list.push({"user_id" : $(this).data('userid')});
		}else{
			i.remove();
			$("#spn_selectednum_alarm").text(parseInt($("#spn_selectednum_alarm").text())-1);
			studentlistremove($(this).data('userid'))
		}
	});


});
