
$(function() {
	moms.polling.stop();

	momsSubTempFrame.timetable.wrapper = $('.time-table');

	// init
	momsSubTempFrame.timetable.init = function(doData){
		
		var params = {
			parent_id : localStorage.getItem('MOMS_id')
		}
		getAjaxPostData("getScheduleList.do?", params, true, function(data){
			console.log(data);
			if(data.resultcode == '0000'){
				for(var i=0; i<data.result.length; i++){
					momsSubTempFrame.timetable.wrapper.find('.t_table[data-days="'+data.result[i].day+'"][data-time="'+data.result[i].time_no+'"]').text(data.result[i].subject_name);
					momsSubTempFrame.timetable.wrapper.find('.t_table[data-days="'+data.result[i].day+'"][data-time="'+data.result[i].time_no+'"]').attr('data-subject',data.result[i].subject_id);
				}

				
				for(var i=0; i<doData.length; i++){
					var target = doData[i];
					var dom = momsSubTempFrame.timetable.wrapper.find('.t_table[data-days='+target.day+'][data-time='+target.time_no+']');
					dom.data("info" , target);
					console.warn("data" , dom);
					dom.unbind("click").on("click" , function(){
						var html = "";
						var d = $(this).data("info")
						html += "<b>["+$(this).text() + "]</b>  ";
						html += "<strong>"+d.user_name+"</strong> 教师<br/>";
						html += "<small>- 单元信息 -</small><br/>";
						html += d.unit_name;
						momsSubTempFrame.wrapper.find('#main_fail_alert .desc')
						.html(html);  //<strong>시간표정보</strong>를<br />불러오지 못했습니다.
                		momsSubTempFrame.wrapper.find('#main_fail_alert').fadeIn(150);
					}).addClass("on_unit");
				}

				momsSubTempFrame.timetable.setColorTable();			// 색상설정
				momsSubTempFrame.timetable.setMonth();				// 현재날짜의 月 설정

			}else{
				momsSubTempFrame.wrapper.find('#main_fail_alert .desc').html('<strong>课程表</strong><br />连接失败。');  //<strong>시간표정보</strong>를<br />불러오지 못했습니다.
                momsSubTempFrame.wrapper.find('#main_fail_alert').fadeIn();
                return;
			}
		});
	}


	// 색상 정의
	momsSubTempFrame.timetable.setColorTable = function(){
		momsSubTempFrame.timetable.wrapper.find('.t_table').each(function(){
			var $this = $(this);
			var $thisData = $this.attr('data-subject');
			var colorClass = '';

			if($thisData == '11'){
				colorClass = 'math';
			}else if($thisData == '12'){
				colorClass = 'lang';
			}else if($thisData == '15'){
				colorClass = 'eng';
			}else if(($thisData == '22')||($thisData == '13')||($thisData == '14')){
				colorClass = 'science';
			}else if($thisData == '23'){
				colorClass = 'chemical';
			}else if($thisData == '17'){
				colorClass = 'organism';
			}else if($thisData == '18'){
				colorClass = 'geography';
			}else if(($thisData == '19')||($thisData == '16')||($thisData == '21')){
				colorClass = 'political';
			}else if($thisData == '20'){
				colorClass = 'history';
			}else if($thisData == '51'){
				colorClass = 'art';
			}else if($thisData == '52'){
				colorClass = 'music';
			}else if(($thisData == '71')||($thisData == '72')){
				colorClass = 'physical';
			}else{
				
			}
			if($this.hasClass("on_unit")){
				$this.parent().addClass(colorClass);	
			}
		});
	}

	// 현재 月 설정
	momsSubTempFrame.timetable.setMonth = function(){
		var currentMonth = new Date();
		momsSubTempFrame.timetable.wrapper.find('.month').text((currentMonth.getMonth()+1)+'月 - '+weekCnt+"周");
	}




	var today = new Date(),
	month = today.getMonth()+1
	weekCnt = getSecofWeek(today);
	//momsSubTempFrame.timetable.init();
	var paramData = {
		class_no: s_defaultInfo.class_no,
		month: month,
		school_year: s_defaultInfo.school_year,
		scid: s_defaultInfo.scid,
		week: weekCnt,
	};
	paramData = JSON.stringify(paramData);
	$.ajax({
		timeout: (1000*60),
		method: "POST",
		url: pcmApiUrl+"/subject/getClassWeekSchedule.do",
		data: paramData,
		contentType : 'application/json; charset=UTF-8',
		dataType: 'json',
		global : false,
		cache: false,
		async: true,
		success: function(jsonData){
			//console.debug("[getAPIDATA]" ,url , paramData, jsonData.resultData)
			result = jsonData.resultData;
			momsSubTempFrame.timetable.init(result);
		},
		error:function (xhr, ajaxOptions, thrownError){
			result = { result: "AjaxFail" };
			
		},
		complete: function(data) {
			
		}
	});

	function getSecofWeek(date){
		date = date || new Date();
		var year = date.getFullYear();
		var month = date.getMonth()+1;
		var day = date.getUTCDate();
		if(10 > parseInt(month) ) month = "0"+month;
		if(10 > parseInt(day) ) day = "0"+day;
		date = year.toString()+month.toString()+day.toString();
        var d = new Date( date.substring(0,4), parseInt(date.substring(4,6))-1, date.substring(6,8) );
        var fd = new Date( date.substring(0,4), parseInt(date.substring(4,6))-1, 1 );
        return Math.ceil((parseInt(date.substring(6,8))+fd.getDay())/7);
   	};
});