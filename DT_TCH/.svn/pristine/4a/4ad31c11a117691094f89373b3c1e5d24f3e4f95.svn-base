
$(function() {
	var params;
	
	tchSubTempFrame.qna = {};
	tchSubTempFrame.qna.wrapper = $('.m_qna');			
	tchSubTempFrame.qna.sFlag = false;	
    currentPage = 1;

 // init
	tchSubTempFrame.qna.init = function() {

		$('#wrapper').show();

		setTimeout(function() {
			$('#wrapper').find('.intro').fadeOut(function() {
				showMain(tchSubTempFrame.qna);
			});
		}, 1500);

		// 获取微信用户信息信息
		// 获取 授权 回调 code
		WXLoad(tchSubTempFrame.alert, tchSubTempFrame.qna.eventBind);
		
		
	}

    // 事件绑定
    tchSubTempFrame.qna.eventBind = function(){
    	tchSubTempFrame.qna.listInit();
    	// pull to refresh
		$('#container').xpull({
			'callback':function(){
				momsSubTempFrame.qna.sFlag = false;
				momsSubTempFrame.qna.listInit();
			}
		});
        // 问答按钮
        tchSubTempFrame.qna.wrapper.find('#btnQaRegist').off(BIND_EVENT_TYPE);
        tchSubTempFrame.qna.wrapper.find('#btnQaRegist').on(BIND_EVENT_TYPE,function(e){
			if(window.jline){
				window.jline.openPopupWebView(uploadUrl + "weixin/qna_write.html");
			}else{
				window.open("./weixin/qna_write.html");
			}
        }
        
        
        );

		// 点击未读过的帖子
		tchSubTempFrame.qna.wrapper.off(BIND_EVENT_TYPE, '.qna_list li');
		tchSubTempFrame.qna.wrapper.on(BIND_EVENT_TYPE, '.qna_list li' ,function(e){
			var $this = $(this);

			if($this.find('h4 .new').length != 0){
				// 읽음 api로 전송 (New 사라짐)
				var params = {
					type : "Q",
					key : $this.data('pqaid'),
					user_id : localStorage.getItem('TCH_id')
				}

				getAjaxPostData("tch/insertRead.do?", params, false, function(data){
					if(data.resultcode == '0000'){
						$this.find('h4').removeClass('new');
						
						//去除未读标记
						$this.find('h4 .new').remove();
						location.href = "../weixin/qna_view.html.html?key="
								+ $this.data('pqaid')
								+ "&scid="
								+ localStorage
										.getItem('TCH_scid');
					}
					/**	
						if(window.jline){
							window.jline.openPopupWebView(uploadUrl + "contents/qna_view.html?pqaid=" + $this.data('pqaid'));
						}else{
							window.open("./contents/qna_view.html?pqaid=" + $this.data('pqaid'));
						}
					}
					**/
						
						else{
						console.log('insertRead 错误');
						return;
					}			
				});
			}else{
				console.log('이미 읽은 게시글');
				
				/**
				if(window.jline){
					window.jline.openPopupWebView(uploadUrl + "contents/qna_view.html?pqaid=" + $this.data('pqaid'));
				}else{
					window.open("./contents/qna_view.html?pqaid=" + $this.data('pqaid'));
				}
				**/
				location.href = "../weixin/qna_view.html.html?key="
					+ $this.data('pqaid')
										+ "&scid="
										+ localStorage.getItem('TCH_scid');
			}
		});
			
    }
    
    // qna list init
    tchSubTempFrame.qna.listInit = function(){
    	// 获取提醒列表数据
		currentPage = 1;
		tchSubTempFrame.qna.sFlag = false;
        var params = {
            user_id:"mtbi2",
        	school_year:"08",
       		class_no:"02",
			currentPage : currentPage
		}

		//리스트 생성
		getAjaxPostData("tch/getParentQaList.do?", params, true, function(data){
			console.log('QNA 表 : ', data);

			tchSubTempFrame.qna.wrapper.find('.qna_list').empty();

			if(data.resultcode == '0000'){
				if(data.result.length == 0){
					tchSubTempFrame.qna.wrapper.find('.emptyMsg').show();		// 리스트 하나도 없을때
				}else{
					tchSubTempFrame.qna.wrapper.find('.emptyMsg').hide();		// empty message hide
					
					var qaListDom = '';

					for(var i=0; i<data.result.length; i++){
						
						writter ='[' + (data.result[i].student_name) + ']' ;

						// 아빠
						if(data.result[i].last_comment_reg_type == 'D'){
							writter += data.result[i].student_name + '的父亲' + data.result[i].last_comment_user_name;
						}else if(data.result[i].last_comment_reg_type == 'M'){
							// 엄마
							writter += data.result[i].student_name + '的母亲' + data.result[i].last_comment_user_name;
						}else if(data.result[i].last_comment_reg_type == 'E'){
							// 보호자
							writter += data.result[i].student_name + '的监护人' + data.result[i].last_comment_user_name;
						}else if(data.result[i].last_comment_reg_type == 'T'){
							// 담임
							writter += '班主任' + data.result[i].last_comment_user_name;
						}else if(data.result[i].last_comment_reg_type == 'S'){
							// 교장
							writter += '校长' + data.result[i].last_comment_user_name;
						}

						qaListDom += '<li style="cursor:pointer" data-pqaid="'+data.result[i].pqaid+'" >';
						qaListDom += '	<span class="thum">';
						qaListDom += '		<img src="'+(((data.result[i].student_photo_path == "") || (data.result[i].student_photo_path === null)) ? defaultProfileImgPath : lmsUrl + data.result[i].student_photo_path )+'" alt="">';
						qaListDom += '	</span>';

						qaListDom += '	<div class="list-cnt">';

						if((data.result[i].is_new == true)){
							qaListDom += '		<h4 class="new" style="margin-top:0px;margin-bottom:0px">'+ writter +'</h4>';
						}else{
							qaListDom += '		<h4 style="margin-top:0px;margin-bottom:0px">'+ writter +'</h4>';
						}

						qaListDom += '		<em class="date">'+ (data.result[i].reg_date).toString().substring(0,16) +'</em>';
						qaListDom += '		<p>'+ data.result[i].last_comment +'</p>';
						qaListDom += '	</div>';
						qaListDom += '</li>';
					}

					tchSubTempFrame.qna.wrapper.find('.qna_list').append(qaListDom);
				}
			}else{
				commonAlert('<strong>目录信息</strong><br />连接失败。', false , null, null);				//<strong>리스트정보</strong>를<br /> 불러오지못했습니다.
				return;
			}
		});
    }


	// qna list append
    tchSubTempFrame.qna.listAppend = function(){
		if(tchSubTempFrame.qna.wrapper.is(':visible')){
			if(!tchSubTempFrame.qna.sFlag){
				currentPage++;

				var params = {
					teacher_id : localStorage.getItem('TCH_id'),
					currentPage : currentPage
				}

				getAjaxPostData("tch/getParentQaList.do?", params, true, function(data){
					console.log('append 데이터 : ', data);
					if(data.resultcode == '0000'){
						if(data.result.length != 0){
							var qaAppendDom = '';
							for(var i=0; i<data.result.length; i++){
								
								writter ='[' + (data.result[i].student_name) + ']' ;

								// 아빠
								if(data.result[i].last_comment_reg_type == 'D'){
									writter += data.result[i].student_name + '的父亲' + data.result[i].last_comment_user_name;
								}else if(data.result[i].last_comment_reg_type == 'M'){
									// 엄마
									writter += data.result[i].student_name + '的母亲' + data.result[i].last_comment_user_name;
								}else if(data.result[i].last_comment_reg_type == 'E'){
									// 보호자
									writter += data.result[i].student_name + '的监护人' + data.result[i].last_comment_user_name;
								}else if(data.result[i].last_comment_reg_type == 'T'){
									// 담임
									writter += '班主任' + data.result[i].last_comment_user_name;
								}else if(data.result[i].last_comment_reg_type == 'S'){
									// 교장
									writter += '校长' + data.result[i].last_comment_user_name;
								}

								qaListDom += '<li style="cursor:pointer" data-pqaid="'+data.result[i].pqaid+'" >';
								qaListDom += '	<span class="thum">';
								qaListDom += '		<img src="'+(((data.result[i].student_photo_path == "") || (data.result[i].student_photo_path === null)) ? defaultProfileImgPath : lmsUrl + data.result[i].student_photo_path )+'" alt="">';
								qaListDom += '	</span>';

								qaListDom += '	<div class="list-cnt">';

								if((data.result[i].comment_count == 0)){
									qaListDom += '		<h4 class="new" style="margin-top:0px;margin-bottom:0px">'+ writter +'</h4>';
								}else{
									qaListDom += '		<h4 style="margin-top:0px;margin-bottom:0px">'+ writter +'</h4>';
								}

								qaListDom += '		<em class="date">'+ (data.result[i].reg_date).toString().substring(0,16) +'</em>';
								qaListDom += '		<p>'+ data.result[i].last_comment +'</p>';
								qaListDom += '	</div>';
								qaListDom += '</li>';
							}

							tchSubTempFrame.qna.wrapper.find('.qna_list').append(qaListDom);
						
						}else{
							tchSubTempFrame.qna.sFlag = true;
						}
					}else{
						commonAlert('<strong>目录信息</strong><br />连接失败。', false , null, null);				//<strong>리스트정보</strong>를<br /> 불러오지못했습니다.
						return;
					}
				});
			}else{
				console.log('no more data');
			}
		}
	}

    
 // 信息提示框 确认按钮事件
	var readyFunc = function onBridgeReady() {

		// 关闭当前webview窗口 - closeWindow
		document.querySelector('#tch_alarm_alert_ok_btn').addEventListener(
				'click', function(e) {
					WeixinJSBridge.invoke('closeWindow', {}, function(res) {
						// alert(res.err_msg);
					});
				});

	}

	if (typeof WeixinJSBridge === "undefined") {
		document.addEventListener('WeixinJSBridgeReady', readyFunc, false);
	} else {
		readyFunc();
	}
	
    tchSubTempFrame.qna.init();
});