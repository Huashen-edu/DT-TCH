/**
 * 授权画面
 */

$(function() {
	var momsLoginFrame = {};
	momsLoginFrame.wrapper = $('#wrapper');
	momsLoginFrame.wrapper.alert = $('#moms_login_alert');

	// init
	momsLoginFrame.init = function() {
		// 简介 show
		if (localStorage.getItem('logout') != 'Y') {

			momsLoginFrame.wrapper.find('.intro').show();
			setTimeout(function() {
				momsLoginFrame.wrapper.find('.intro').fadeOut(function() {
					momsLoginFrame.showLogin();
				});
			}, 1500);

			// 获取 授权 回调 code
			var wmcode = GetQueryString("code");
			momsLoginFrame.wrapper.find('input[name=wxcode]').val(wmcode);

			// 获取 用户 useid
			var params = {
				code : wmcode
			};

			// 获取 微信userinfo
			getAjaxPostData(
					'getWXUserInfo.do?',
					params,
					true,
					function(data) {
						console.log(data);
						var response = data;
						if (response.resultcode == '0000'
								&& typeof (response.result) == "object") {
							// 获取用户微信信息和用户信息
							localStorage.setItem('TCH_wx_user_id',
									response.result.wx_user_id); // 用户微信ID
							localStorage.setItem('TCH_device_id',
									response.result.device_id); // 手机设备ID
							if (response.result.user_id != null) {
								localStorage.setItem('TCH_id',
										response.result.user_id);// 用户ID
							}
							// TODO:
							momsLoginFrame.wrapper
									.find('input[name=wxuserid]')
									.val(localStorage.getItem('TCH_wx_user_id'));
							momsLoginFrame.wrapper.find(
									'input[name=wxdeviceId]').val(
									localStorage.getItem('TCH_device_id'));
						}
					});
		} else { // 登录注销后 show
			momsLoginFrame.showLogin();
			localStorage.clear();
		}
	}

	// login show
	momsLoginFrame.showLogin = function() {
		momsLoginFrame.wrapper.removeClass('page-center');
		momsLoginFrame.wrapper.find('#container').fadeIn(function() {
			momsLoginFrame.eventBind();
		});
	}

	// event bind
	momsLoginFrame.eventBind = function() {
		// 登录按钮事件
		momsLoginFrame.wrapper.find('#moms_login_btn').on(
				BIND_EVENT_TYPE,
				function() {
					var userId = momsLoginFrame.wrapper.find(
							'input[name=userId]').val(); // ID
					var pass = momsLoginFrame.wrapper.find('input[name=pass]')
							.val(); // 密码
					if (userId == '') {
						commonAlert('请输入<strong>ID</strong>。', false, null,
								null);
						return;
					}

					// TODO:userId = 'p' + userId;
					userId = userId.toLowerCase();

					if (pass == '') {
						commonAlert('请输入<strong>密码</strong>。', false, null,
								null);
						return;
					}

					// TODO:获取用户类型
					var userType = 'T';
					// if ($('#moms_student_check').is(':checked')) {
					// // 学生
					// userType = 'S';
					// } else if ($('#moms_teacher_check').is(':checked')) {
					// // 教师
					// userType = 'T';
					// } else {
					// // 家长
					// userType = 'P';
					// }
					var wx_user_id = localStorage.getItem('TCH_wx_user_id');
					var device_id = localStorage.getItem('TCH_device_id');
					momsLoginFrame.authorize(userId, pass, userType,
							wx_user_id, device_id); // 授权登录
				});

		// 信息提示框 确认按钮事件
		var readyFunc = function onBridgeReady() {
			var curid;
			var curAudioId;
			var playStatus = 0;

			// 关闭当前webview窗口 - closeWindow
			document.querySelector('#moms_login_alert_ok_btn')
					.addEventListener('click', function(e) {
						WeixinJSBridge.invoke('closeWindow', {}, function(res) {
							// alert(res.err_msg);
						});
					});

		}

		if (typeof WeixinJSBridge === "undefined") {
			document.addEventListener('WeixinJSBridgeReady', readyFunc, false);
		} else {
			readyFunc();
		}
	}

	// 授权登录
	momsLoginFrame.authorize = function(user_id, pass, user_type, wx_user_id,
			device_id) {
		var params = {
			user_id : user_id,// 用户id
			pass : pass,// 密码
			user_type : user_type,// 用户类型 S：学生 T：教师 P：父母
			wx_user_id : wx_user_id,// 微信userID
			device_id : device_id,// 手机设备号
		}

		getAjaxPostData('setAuthorize.do?', params, true, function(data) {
			console.log(data);
			var response = data;

			if (response.resultcode == '0000') {
				if (response.result == 'fail') {
					commonAlert(
							'请确认<strong>ID</strong>和<strong>密码</strong>是否正确。',
							false, null, null);
					momsLoginFrame.wrapper.find('input[name=userId]').focus();
					return;
				} else if (response.result == 'DBfail') {
					commonAlert('目前服务器异常，请<strong>稍后</strong>再尝试。', false,
							null, null);
					momsLoginFrame.wrapper.find('input[name=userId]').focus();
					return;
				} else if (response.result == 'IsDelete') {
					commonAlert('此用户已被系统删除<br>请与<strong>管理员</strong>联系。', false,
							null, null);
					momsLoginFrame.wrapper.find('input[name=userId]').focus();
					return;
				} else if (typeof (response.result) == "object") {
					localStorage.setObject('s_defaultInfo', response.result);
					sessionStorage['TCH_id'] = response.result.user_id; // 用户ID
					localStorage.setItem('TCH_id', response.result.user_id); // 用户ID
					localStorage.setItem('TCH_pass', response.result.user_pw); // 密码
					localStorage.setItem('TCH_usertype',
							response.result.user_type); // 用户类型
					console.debug("注册资料和信息", data);

					// 在每个级别设置科目
					setMomsSubjectObj(function() {
						// 本地存储 在每个级别存储的Obj科目
						localStorage
								.setObject('momsSubjectObj', momsSubjectObj);
					});
					momsLoginFrame.wrapper.alert.find('.desc').html(
							'<strong>授权成功</strong><strong></strong>，请关闭此画面。');
					momsLoginFrame.wrapper.alert.fadeIn();
					return;
				}
			} else {
				commonAlert('处理失败', false, null, null);
				return;
			}
		});
	};

	momsLoginFrame.init();
});