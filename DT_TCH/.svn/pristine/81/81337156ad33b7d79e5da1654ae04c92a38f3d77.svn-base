$(function() {
	var momsLoginFrame = {};
	momsLoginFrame.wrapper = $('#wrapper');
	momsLoginFrame.wrapper.alert = $('#moms_login_alert');

	// init
	momsLoginFrame.init = function(){
		// 인트로 show
		if(localStorage.getItem('logout') != 'Y'){
			momsLoginFrame.wrapper.find('.intro').show();
			setTimeout(function(){
				momsLoginFrame.wrapper.find('.intro').fadeOut(function(){
					momsLoginFrame.showLogin();
				});
			},1500);
		}else{		// 로그아웃 후엔 인트로 없이 로그인 show
			momsLoginFrame.showLogin();
			localStorage.clear();
		}
	}

	// login show
	momsLoginFrame.showLogin = function(){
		momsLoginFrame.wrapper.removeClass('page-center');
		momsLoginFrame.wrapper.find('#container').fadeIn(function(){
			momsLoginFrame.eventBind();
			
			// 자동로그인 체크시 로그인 바로 시도
			if(localStorage.getItem('autoLogin') == 'Y'){
				momsLoginFrame.wrapper.find('#moms_autoLogin_check').prop('checked',true);
				momsLoginFrame.wrapper.find('input[name=userId]').val(localStorage.getItem('MOMS_id'));
				momsLoginFrame.wrapper.find('input[name=pass]').val(localStorage.getItem('MOMS_pass'));
				momsLoginFrame.tryLogin(localStorage.getItem('MOMS_id'),localStorage.getItem('MOMS_pass'));
			}else{
				return;
			}
		});
	}

	// event bind
	momsLoginFrame.eventBind = function(){
		// 로그인 버튼
		momsLoginFrame.wrapper.find('#moms_login_btn').on(BIND_EVENT_TYPE,function(){
			var userId = 'p' + momsLoginFrame.wrapper.find('input[name=userId]').val();	// 아이디
			var pass = momsLoginFrame.wrapper.find('input[name=pass]').val();		// 비밀번호

			if(userId == ''){
				momsLoginFrame.wrapper.alert.find('.desc').html('请输入<strong>ID</strong>。'); //<strong>아이디</strong>를 입력하세요.
				momsLoginFrame.wrapper.alert.fadeIn();
				return;
			}

			if(pass == ''){
				momsLoginFrame.wrapper.alert.find('.desc').html('请输入<strong>密码</strong>。'); //<strong>비밀번호</strong>를 입력하세요.
				momsLoginFrame.wrapper.alert.fadeIn();
				return;
			}
			
			userId = userId.toLowerCase();
			momsLoginFrame.tryLogin(userId, pass);		// 로그인 시도
		});

		// 로그인 alert 확인버튼
		momsLoginFrame.wrapper.alert.find('#moms_login_alert_ok_btn').on(BIND_EVENT_TYPE,function(){
			momsLoginFrame.wrapper.find('#moms_login_alert').fadeOut();
		});

		// 자동로그인 체크박스
		momsLoginFrame.wrapper.find('#moms_autoLogin_check').on(BIND_EVENT_TYPE,function(){
			var $this = $(this);

			// 체크시
			if($this.prop('checked')){
				localStorage.setItem('autoLogin','Y');
			}else{	// 체크 해제시
				localStorage.setItem('autoLogin','N');
			}
		});
	}


	// 로그인 시도
	momsLoginFrame.tryLogin = function(userId, pass){
		var params = {
			userId : userId,
			pass : pass
		}

		getAjaxPostData('login.do?', params , true, function(data){
			console.log(data);
			var response = data;

			if(response.resultcode == '0000' && typeof(response.result) == "object" ){
				console.log('로그인 성공');
				
				localStorage.setObject('s_defaultInfo',response.result);

				sessionStorage['moms_id'] = userId;							// 세션 스토리지 id 저장

				localStorage.setItem('MOMS_id',userId);						// 로컬 스토리지 id 저장
				localStorage.setItem('MOMS_pass',pass);						// 로컬 스토리지 pass 저장
				//localStorage.setItem('MOMS_info', data);
				console.debug("注册资料和信息" , data);

				// 학년별 과목 설정
				setMomsSubjectObj(function(){
					// 로컬스토리지에 학년별과목 obj 저장
					localStorage.setObject('momsSubjectObj',momsSubjectObj);

					self.location.href = 'sub_temp.html';
				});
			}else{
				momsLoginFrame.wrapper.alert.find('.desc').html('请确认<strong>ID</strong>和<strong>密码</strong>是否正确。'); //<strong>아이디</strong> 혹은 <strong>비밀번호</strong>를<br />다시 확인하세요.
				momsLoginFrame.wrapper.alert.fadeIn();
				momsLoginFrame.wrapper.find('input[name=userId]').focus();
				return;
			}
		});
	}

	momsLoginFrame.init();
});