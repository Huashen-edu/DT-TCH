<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="tch">


	<select
		id="getUserList"
		resultType="com.digital.tch.china.vo.User"
		parameterType="com.digital.tch.china.vo.User">
		SELECT
		*
		FROM t_user
		WHERE user_id = #{user_id} and user_pw
		= #{user_pw} and scid!=0 and user_type='T'
	</select>
	<select
		id="getStudentInfo"
		resultType="com.digital.tch.china.vo.User"
		parameterType="com.digital.tch.china.vo.User">


		SELECT *
		FROM t_user
		WHERE user_id = (
		SELECT b.user_id
		FROM t_user
		a,t_student_parents b
		WHERE a.user_id=#{user_id} AND
		a.user_id =
		b.parent_id )
	</select>
	<select
		id="getUserInfo"
		resultType="com.digital.tch.china.vo.User"
		parameterType="com.digital.tch.china.vo.User">


		SELECT *,(select code_name from t_code where
		code_group='33' and
		code_id=parent_job) as parent_job_name,
		(select
		code_name from t_code where code_group='31' and code_id=national) as
		national_name,
		(SELECT name FROM t_originate WHERE oid=originate) as
		originate_name
		FROM t_user a,(
		SELECT user_name as student_name
		FROM
		t_user
		WHERE user_id = (
		SELECT b.user_id
		FROM t_user
		a,t_student_parents
		b
		WHERE a.user_id=#{user_id} AND a.user_id =
		b.parent_id )) b
		WHERE
		user_id = #{user_id}
	</select>

	<insert
		id="updateParent"
		parameterType="com.digital.tch.china.vo.User">
		UPDATE t_user SET
		user_pw=#{user_pw},user_email=#{user_email},phone=#{phone},sex=#{sex},photo_path=#{photo_path},
		birthday=#{birthday},address=#{address},sns=#{sns},parent_job=#{parent_job}
		WHERE user_id = #{user_id}
	</insert>

	<select
		id="getNoticeList"
		resultType="com.digital.tch.china.vo.Notice"
		parameterType="com.digital.tch.china.vo.SearchCondition">

		SELECT (select code_name from t_code where
		code_id=a.speaker and
		code_group=23 ) as
		speaker,a.*,ifnull(C.nread_id,0) as new_cnt
		FROM
		t_notice a left join
		t_notice_read C on ( a.nid = C.nid and
		C.user_id=#{user_id}),t_user b
		WHERE a.scid=b.scid AND ( a.target like
		'%S%' or a.target like '%P%' )
		AND b.user_id=#{user_id}
		ORDER BY a.reg_date desc
		LIMIT
		#{currentPage},#{recordCnt}
	</select>
	<select
		id="getNoticeFileList"
		resultType="com.digital.tch.china.vo.NoticeFile"
		parameterType="com.digital.tch.china.vo.Notice">

		SELECT *
		FROM t_notice_file
		WHERE nid = #{nid}
	</select>
	<select
		id="getAlarmList"
		resultType="com.digital.tch.china.vo.Alarm"
		parameterType="com.digital.tch.china.vo.SearchCondition">

		SELECT
		a.aid,a.title,a.user_id,a.reg_date,ifnull(C.aid,0) as
		new_cnt,e.subject,
		IFNULL((select code_name from t_code where
		code_group='02' and code_id=e.subject),'班主任') as
		subject_name,d.user_name
		FROM t_alarm a left join t_alarm_read C on (
		a.aid = C.aid and C.user_id=#{user_id} ) ,t_alarm_students b,
		(
		SELECT
		b.user_id,a.reg_date
		FROM t_user a,t_student_parents b
		WHERE
		a.user_id=#{user_id} AND a.user_id = b.parent_id ) m,t_user
		d,t_alarm_class e
		WHERE a.aid =b.aid AND b.user_id=m.user_id
		AND
		a.aid=e.aid
		AND a.user_id = d.user_id AND a.is_delete='N' and
		a.reg_date > m.reg_date
		ORDER BY a.reg_date desc

		LIMIT
		#{currentPage},#{recordCnt}
	</select>
	<select id="getAlarmInfo" resultType="com.digital.tch.china.vo.Alarm" parameterType="com.digital.tch.china.vo.Alarm">
		SELECT a.*,d.user_name
		FROM t_alarm a,t_user d 
		WHERE a.aid = #{aid} and a.user_id = d.user_id    
        and d.is_delete='N'
    </select>
	<select
		id="getAlarmFileList"
		resultType="com.digital.tch.china.vo.AlarmFile"
		parameterType="com.digital.tch.china.vo.Alarm">

		SELECT *
		FROM t_alarm_file
		WHERE aid = #{aid}
	</select>
	<select
		id="getQaSubjectList"
		resultType="com.digital.tch.china.vo.QaSubject"
		parameterType="com.digital.tch.china.vo.QaSubject">


		SELECT A.user_id as teacher_id,'00' as subject ,'班主任' as
		subject_name,A.class_no
		FROM t_user A,(
		SELECT school_year,class_no
		FROM
		t_user
		WHERE user_id = (
		SELECT b.user_id
		FROM t_user
		a,t_student_parents
		b
		WHERE a.user_id=#{parent_id} AND a.user_id =
		b.parent_id) )B
		WHERE
		A.school_year = B.school_year AND A.class_no =
		B.class_no
		AND
		A.user_type='T' AND A.teacher_charge='Y' AND
		A.is_delete='N'

		UNION

		SELECT A.user_id as teacher_id,A.duty_subject as subject,
		(select
		code_name
		as subject_name from t_code where code_group='02' and
		code_id=A.duty_subject),
		B.class_no
		FROM t_teacher_duty A,t_user C,
		(SELECT school_year,class_no
		FROM t_user
		WHERE user_id = (
		SELECT
		b.user_id
		FROM t_user
		a,t_student_parents b
		WHERE a.user_id=#{parent_id}
		AND a.user_id =
		b.parent_id ))B
		WHERE A.duty_school_year = B.school_year
		AND
		A.duty_school_class_no = B.class_no
		AND A.user_id = C.user_id AND
		C.is_delete='N'
	</select>
	<insert
		id="insertParentQa"
		parameterType="com.digital.tch.china.vo.ParentQa">
		INSERT INTO t_parent_qa (
		parent_id,contents,subject,class_no,teacher_id )
		VALUES(
		#{parent_id},#{contents},#{subject},#{class_no},#{teacher_id})
	</insert>
	<update
		id="updateParentQa"
		parameterType="com.digital.tch.china.vo.ParentQa">
		UPDATE t_parent_qa SET
		contents=#{contents},reg_date=now()
		WHERE pqaid=#{pqaid}
	</update>
	<update
		id="deleteParentQa"
		parameterType="com.digital.tch.china.vo.ParentQa">
		UPDATE t_parent_qa SET
		is_delete='Y'
		WHERE pqaid=#{pqaid}
	</update>
	<insert
		id="insertParentQaComment"
		parameterType="com.digital.tch.china.vo.ParentQa">
		INSERT INTO t_parent_qa_comment ( pqaid,user_id,comment
		)
		VALUES( #{pqaid},#{user_id},#{comment})
	</insert>


	<select
		id="getParentQaList"
		resultType="com.digital.tch.china.vo.ParentQa"
		parameterType="com.digital.tch.china.vo.SearchCondition">

		SELECT a.*,count(b.pqaid) as
		comment_cnt,ifnull(C.pqaid,0) as new_cnt
		FROM
		t_parent_qa a left join
		t_parent_qa_comment b on ( a.pqaid = b.pqaid )
		left join
		t_parent_qa_read C on ( a.pqaid = C.pqaid and
		C.user_id=#{user_id})
		WHERE a.parent_id=#{user_id} AND a.is_delete='N'
		GROUP BY a.pqaid
		ORDER
		BY a.reg_date desc
		LIMIT
		#{currentPage},#{recordCnt}
	</select>
	<select
		id="getPQCommentList"
		resultType="com.digital.tch.china.vo.ParentQa"
		parameterType="com.digital.tch.china.vo.ParentQa">

		SELECT a.*,b.user_name,b.user_type,b.photo_path
		FROM
		t_parent_qa_comment
		a,t_user b
		WHERE pqaid=#{pqaid} AND
		a.user_id=b.user_id
		ORDER BY
		comment_id
	</select>
	<select
		id="getScheduleList"
		resultType="com.digital.tch.china.vo.Schedule"
		parameterType="com.digital.tch.china.vo.Schedule">
		SELECT A.day,A.time_no,A.subject_id,
		IF (
		LENGTH(A.subject_id) &lt; 3 ,(select code_name from t_code where
		code_group='02' and code_id=A.subject_id) ,
		(select code_name from
		t_code where code_group='61' and code_id=A.subject_id)) as
		subject_name
		FROM t_time_schedule A,(
		SELECT school_year,class_no,scid
		FROM t_user
		WHERE user_id = (
		SELECT b.user_id
		FROM t_user
		a,t_student_parents b
		WHERE a.user_id=#{parent_id} AND a.user_id =
		b.parent_id )) B

		WHERE A.school_year=B.school_year AND
		A.class_no=B.class_no AND
		A.scid=B.scid



	</select>
	<update
		id="updateParentQaComment"
		parameterType="com.digital.tch.china.vo.ParentQa">
		UPDATE t_parent_qa_comment SET
		comment =#{comment}
		WHERE
		comment_id = #{comment_id}
	</update>
	<delete
		id="deleteParentQaComment"
		parameterType="com.digital.tch.china.vo.ParentQa">
		DELETE FROM t_parent_qa_comment
		WHERE comment_id =
		#{comment_id}
	</delete>

	<insert
		id="insertNoticeRead"
		parameterType="com.digital.tch.china.vo.SearchCondition">
		INSERT INTO t_notice_read ( nid,user_id )
		VALUES(
		#{key},#{user_id})
	</insert>
	<insert
		id="insertAlarmRead"
		parameterType="com.digital.tch.china.vo.SearchCondition">
		INSERT INTO t_alarm_read ( aid,user_id )
		VALUES(
		#{key},#{user_id})
	</insert>
	<insert
		id="insertParentQaRead"
		parameterType="com.digital.tch.china.vo.SearchCondition">
		INSERT INTO t_parent_qa_read ( pqaid,user_id )
		VALUES(
		#{key},#{user_id})
	</insert>
	<delete
		id="deleteParentQaRead"
		parameterType="com.digital.tch.china.vo.ParentQa">
		DELETE FROM t_parent_qa_read
		WHERE pqaid = #{pqaid} AND
		user_id=#{user_id}
	</delete>

	<select
		id="getNoticeNewCount"
		resultType="com.digital.tch.china.vo.Notice"
		parameterType="com.digital.tch.china.vo.SearchCondition">

		SELECT notice_cnt ,alarm_cnt ,qa_cnt FROM (

		SELECT
		count(*) as notice_cnt FROM (
		SELECT ifnull(C.nread_id,0) as new_cnt
		FROM t_notice a left join t_notice_read C on ( a.nid = C.nid and
		C.user_id=#{user_id}),t_user b
		WHERE a.scid=b.scid AND ( a.target like
		'%S%' or a.target like '%P%' )
		AND b.user_id=#{user_id} ) A
		WHERE
		A.new_cnt = 0 ) M,(


		SELECT count(*) as alarm_cnt FROM (
		SELECT
		ifnull(C.aid,0) as new_cnt
		FROM t_alarm a left join t_alarm_read C on (
		a.aid = C.aid and
		C.user_id=#{user_id} ) ,t_alarm_class b,
		(SELECT *
		FROM t_user
		WHERE user_id = (
		SELECT b.user_id
		FROM t_user
		a,t_student_parents b
		WHERE a.user_id=#{user_id} AND a.user_id =
		b.parent_id ) ) c
		WHERE a.aid =b.aid AND b.school_year=c.school_year
		AND
		b.class_no=c.class_no ) A
		WHERE A.new_cnt = 0 ) N ,(

		SELECT count(*)
		as qa_cnt FROM (
		SELECT a.pqaid,count(*) as cnt FROM t_parent_qa a
		,t_parent_qa_comment b
		WHERE a.pqaid = b.pqaid and
		a.parent_id=#{user_id} group by a.pqaid) A
		left join t_parent_qa_read C
		on ( A.pqaid = C.pqaid and
		C.user_id=#{user_id})
		WHERE ( cnt mod 2 ) !=
		0 AND C.pread_id is null ) K
	</select>

	<select
		id="getAccessToken"
		resultType="com.digital.tch.china.vo.AccessToken">
		SELECT *
		FROM t_weixin_access_token
		LIMIT 1
	</select>

	<insert
		id="insertAccessToken"
		parameterType="com.digital.tch.china.vo.AccessToken">
		INSERT INTO t_weixin_access_token (
		access_token,expires_in,up_date )
		VALUES(
		#{access_token},#{expires_in},now())
	</insert>

	<update
		id="updateAccessToken"
		parameterType="com.digital.tch.china.vo.AccessToken">
		UPDATE t_weixin_access_token SET
		access_token
		=#{access_token},expires_in =#{expires_in},up_date=now()
	</update>

	<select
		id="getWXUserInfo"
		resultType="com.digital.tch.china.vo.WXUserInfo"
		parameterType="com.digital.tch.china.vo.WXUserInfo">
		SELECT *
		FROM t_weixin_user
		WHERE wx_user_id =
		#{wx_user_id}
		LIMIT 1
	</select>

	<insert
		id="insertAuthorize"
		parameterType="com.digital.tch.china.vo.WXUserInfo">
		INSERT INTO t_weixin_user (
		user_id,user_type,wx_user_id,device_id,ins_date )
		VALUES(
		#{user_id},#{user_type},#{wx_user_id},#{device_id},now())
	</insert>

	<update
		id="updateAuthorize"
		parameterType="com.digital.tch.china.vo.WXUserInfo">
		UPDATE t_weixin_user SET
		user_id
		=#{user_id},user_type =#{user_type},device_id
		=#{device_id},up_date=now()
		WHERE wx_user_id = #{wx_user_id}
	</update>

	<select
		id="getNoticeInfo"
		resultType="com.digital.tch.china.vo.Notice"
		parameterType="com.digital.tch.china.vo.SearchCondition">
		SELECT (select code_name from t_code where
		code_id=a.speaker and code_group=23 ) as speaker,a.*
		FROM t_notice a
		WHERE nid = #{nid}
	</select>
	
	<select id="getAlarmListBySubjectTeacher" resultType="com.digital.tch.china.vo.TchAlarm" parameterType="java.util.HashMap">
		SELECT
			alarm.aid
		    ,alarm.user_id
		    ,alarm.title
		    ,alarm.reg_date
		    ,alarmClass.acid 
		    ,alarmClass.school_year AS target_school_year
		    ,alarmClass.class_no AS target_class_no
		    ,alarmClass.subject AS subject_id
		    ,userInfo.school_year 
		    ,userInfo.class_no
		    ,userInfo.user_name 
		    ,IFNULL(codeInfo.code_name,"") AS subject_name
            ,CONCAT('[',GROUP_CONCAT('"',alarmClass.school_year,'-',alarmClass.class_no,'"') ,']') AS targetClass
			,IF((SELECT COUNT(afid) FROM t_alarm_file WHERE aid = alarm.aid ) = 0 , "false","true") as isFile
			,ifnull(tar.aid,0) AS new_cnt  
		FROM t_alarm AS alarm
		INNER JOIN t_user AS userInfo ON userInfo.user_id = alarm.user_id 
		LEFT JOIN t_alarm_class as alarmClass ON alarmClass.aid = alarm.aid 
		LEFT JOIN t_code AS codeInfo ON (codeInfo.code_group = '02' AND alarmClass.subject = codeInfo.code_id)
		LEFT JOIN t_alarm_read AS tar ON  tar.aid = alarmClass.aid
		WHERE 1=1
		AND alarm.is_delete = 'N'
		AND userInfo.scid = #{scid}
        AND alarm.user_id = #{user_id}
        AND alarmClass.subject = "00"
      	<if test="school_year != null">
		AND alarmClass.school_year = #{school_year}
		</if>
        GROUP BY alarm.aid,alarmClass.subject
		ORDER BY alarm.reg_date DESC
		LIMIT
		#{currentPage},#{recordCnt}
	</select>

	<select
		id="getUserFromWX"
		resultType="com.digital.tch.china.vo.User"
		parameterType="com.digital.tch.china.vo.User">
		SELECT
		*
		FROM t_user
		WHERE user_id = #{user_id}and user_pw
		= #{user_pw} and scid!=0 and user_type=#{user_type}
	</select>
	
	<select id="getTchNoticeList" resultType="com.digital.tch.china.vo.Notice" parameterType="java.util.HashMap">
		SELECT
		*
		FROM(
			SELECT
				notice.nid
				,notice.scid
				,IFNULL(notice.title,"") AS title
				,IFNULL(notice.user_id,"") AS user_id
				,IFNULL(notice.target,"") AS target
				,notice.reg_date 
				,IFNULL(code.code_name,"") AS speaker
                ,noticeRead.nread_id
                ,IF(noticeRead.user_id IS NULL ,"0","1") AS new_cnt
                ,IF((SELECT COUNT(nid) FROM t_notice_file WHERE nid = notice.nid) > 0 , "true","false") AS file_added
			FROM t_notice AS notice
	        INNER JOIN t_code AS code ON code.code_group = '23' AND notice.speaker = code_id
			LEFT JOIN t_notice_read AS noticeRead ON (
            	noticeRead.nid = notice.nid 
                AND noticeRead.user_id = (
					SELECT
                    	user_id
                    FROM t_user
                    WHERE is_delete = 'N'
                    AND scid = #{scid}
                    AND user_id = #{user_id}
	            )
            )
			WHERE 1=1
			AND scid = #{scid}
			AND (target like CONCAT('%', 'T', '%') )
		) AS notice
		WHERE 1=1
		ORDER BY notice.reg_date DESC
		LIMIT #{currentPage} , #{recordCnt}	
	</select>

</mapper>